{% extends "base.html" %}

{% block title %}论文分析结果 - ReadPaper With Code{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', path='/css/blog.css') }}" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Blog Content -->
        <article class="blog-article">
            {% for section_key, section in sections.items() %}
            <section class="blog-section" id="{{ section_key }}">
                <div class="section-header">
                    <h2 class="section-title">{{ section.title }}</h2>
                </div>
                
                <div class="section-content">
                    {{ section.content | nl2br | safe }}
                </div>

                <!-- Details/Expansions -->
                {% if section.details %}
                <div class="section-details mt-4">
                    {% for detail in section.details %}
                    <div class="detail-item">
                        <div class="detail-header">
                            <h4 class="detail-title">
                                <i class="fas fa-chevron-right detail-toggle" data-target="#detail-{{ loop.index }}"></i>
                                {{ detail.title }}
                            </h4>
                        </div>
                        <div class="detail-content collapse" id="detail-{{ loop.index }}">
                            {% if detail.type == 'pseudocode' %}
                            <pre><code class="language-python">{{ detail.content }}</code></pre>
                            {% elif detail.type == 'mermaid' %}
                            <div class="mermaid">{{ detail.content }}</div>
                            {% elif detail.type == 'architecture' %}
                            <div class="architecture-diagram">{{ detail.content | nl2br | safe }}</div>
                            {% else %}
                            <p>{{ detail.content | nl2br | safe }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </section>
            {% endfor %}
        </article>

        <!-- Code Analysis Section -->
        {% if has_code %}
        <section class="code-analysis-section mt-5">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-code"></i> 代码分析
                    </h3>
                </div>
                <div class="card-body">
                    <div class="code-tabs">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#pseudocode">
                                    伪代码
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#architecture">
                                    架构
                                </a>
                            </li>
                        </ul>
                        <div class="tab-content mt-3">
                            <div class="tab-pane active" id="pseudocode">
                                <pre><code class="language-python">{{ code_analysis.pseudocode if code_analysis else "" }}</code></pre>
                            </div>
                            <div class="tab-pane" id="architecture">
                                <div class="architecture-content">
                                    {{ code_analysis.architecture | nl2br | safe if code_analysis else "" }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <!-- Sidebar -->
        <aside class="blog-sidebar sticky-top">
            <!-- Table of Contents -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> 目录
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled toc-list">
                        {% for section_key, section in sections.items() %}
                        <li>
                            <a href="#{{ section_key }}" class="toc-link">
                                {{ section.title }}
                            </a>
                        </li>
                        {% endfor %}
                        {% if has_code %}
                        <li>
                            <a href="#code-analysis" class="toc-link">
                                代码分析
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <!-- Knowledge Base -->
            {% if knowledge_base.sources %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-database"></i> 知识库
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        {% for source in knowledge_base.sources %}
                        <li class="mb-2">
                            <small class="text-muted">{{ source }}</small>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tools"></i> 操作
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="window.print()">
                            <i class="fas fa-print"></i> 打印
                        </button>
                        <button class="btn btn-outline-success" id="exportBtn">
                            <i class="fas fa-download"></i> 导出HTML
                        </button>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-plus"></i> 分析新论文
                        </a>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script>
// Initialize Mermaid
mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    themeVariables: {
        fontFamily: 'Arial, sans-serif'
    }
});

// Initialize detail toggles
document.querySelectorAll('.detail-toggle').forEach(toggle => {
    toggle.addEventListener('click', function() {
        const target = document.querySelector(this.dataset.target);
        if (target) {
            const collapse = new bootstrap.Collapse(target);
            this.classList.toggle('rotated');
        }
    });
});

// Export functionality
document.getElementById('exportBtn')?.addEventListener('click', function() {
    const htmlContent = document.documentElement.outerHTML;
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'paper_analysis.html';
    a.click();
    URL.revokeObjectURL(url);
});

// Smooth scrolling for TOC links
document.querySelectorAll('.toc-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({ behavior: 'smooth' });
        }
    });
});
</script>
{% endblock %}